# Decrypt Attestation Records Script

This script decrypts encrypted attestation records generated by Hyper Protect Virtual Server (HPVS) instances using `contract-cli`. Attestation records contain cryptographic hashes that verify workload integrity and security configuration.

## Prerequisites

Prepare your environment according to [these steps](../README.md).
Ensure that the HPVS CLI tool (contract-cli) is downloaded, renamed, and available on your system as described earlier.

## What are Attestation Records?

Attestation records are encrypted files generated by Hyper Protect instances that contain:
- Cryptographic hashes of deployed workloads
- Contract verification data
- Security configuration checksums
- Boot and runtime integrity measurements

## Usage

### 1. Configure the CLI path
Open the `decryptAttestation.sh` script and update the CLI variable to point to the location where you downloaded the `contract-cli` binary.

Example:
```text
CLI=./contract-cli
```

### 2. Obtain Required Files

You need two files to decrypt attestation records:

#### a. Encrypted Attestation File
Download the encrypted attestation file from your HPVS instance

#### b. Private Key
You need the private key that corresponds to the public key used when creating the HPVS instance. This is the same key pair used for signing the contract.

Update the file paths in the script:
```bash
ENCRYPTED_ATTESTATION_FILE="./se-checksums.txt.enc"
PRIVATE_KEY_FILE="./private.key"
```

### 3. Run the Script
Make the script executable and run it:

```bash
chmod +x decryptAttestation.sh
./decryptAttestation.sh
```

## What the Script Does

The script demonstrates two usage examples:

### Example 1: Decrypt and Save to File
- Decrypts the encrypted attestation records
- Saves the decrypted output to a file (`decrypted_attestation.txt`)
- Displays a success message

### Example 2: Decrypt and Output to Stdout
- Decrypts the encrypted attestation records
- Prints the decrypted content directly to the terminal
- Useful for piping to other commands or immediate inspection

## Command Options

The `decrypt-attestation` command supports the following flags:

- `--in`: (Required) Path to encrypted attestation file (se-checksums.txt.enc)
- `--priv`: (Required) Path to private key file for decryption
- `--out`: (Optional) Path to save decrypted attestation records (prints to stdout if not specified)

## Examples

### Decrypt and save to file:
```bash
./contract-cli decrypt-attestation \
  --in ./se-checksums.txt.enc \
  --priv ./private.key \
  --out decrypted_attestation.txt
```

### Decrypt and output to stdout:
```bash
./contract-cli decrypt-attestation \
  --in ./se-checksums.txt.enc \
  --priv ./private.key
```

### Decrypt and search for specific content:
```bash
./contract-cli decrypt-attestation \
  --in ./se-checksums.txt.enc \
  --priv ./private.key | grep "workload"
```

## Troubleshooting

### Error: "Encrypted attestation file not found"
- Ensure you've downloaded the file from your HPVS instance
- Check the file path in the script matches your actual file location

### Error: "Private key file not found"
- Verify you have the correct private key
- Ensure the key corresponds to the public key used during instance creation

### Decryption Fails
- Confirm you're using the correct private key
- Verify the attestation file is from the expected HPVS instance
- Check that the file hasn't been corrupted during transfer

## Related Commands

- `encrypt`: Encrypt contracts for deployment (uses same key pair)
- `validate-contract`: Validate contract before encryption
- `download-certificate`: Download encryption certificates
